<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.73.0" />

    
    
    

<title>Docker containers for Visual Regression Testing setup • Serban Balamaci</title>













    
<meta property="og:locale" content="en">
<meta property="og:site_name" content="Serban Balamaci">
<meta property="og:title" content="Docker containers for Visual Regression Testing setup">
<meta property="og:type" content="website">
<meta property="og:url" content="https://balamaci.ro/2015/08/03/docker-container-for-visual-regression-testing/" />
<meta property="og:description" content="Java mostly, and general tech">
<meta property="og:image" content="https://balamaci.ro/social-sharing.png">
<meta property="og:image:type" content="image/png">
    
    
    
<meta property="og:image:width" content="192">
<meta property="og:image:height" content="192">
    

<meta property="og:updated_time" content="2015-08-03T19:47:49Z">



<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@sbalamaci">
<meta name="twitter:title" content="Docker containers for Visual Regression Testing setup">

<meta name="twitter:image" content="https://balamaci.ro/social-sharing.png">

<meta name="twitter:description" content="Java mostly, and general tech">
<meta name="twitter:creator" content="@sbalamaci">
    
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/a11y-light.min.css" media="(prefers-color-scheme: light)"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/gruvbox-dark.min.css" media="(prefers-color-scheme: dark)">




<link rel="stylesheet" href="/scss/hyde-hyde.57d57be207f95258b69c5563e34ed2c632000ecb862ce9bd97e7e35f3957094c.css" integrity="sha256-V9V74gf5Uli2nFVj407SxjIADsuGLOm9l&#43;fjXzlXCUw=">


<link rel="stylesheet" href="/scss/hyde-hyde-dark.2eddfb769610f72f40f6bc949e62a3acf298eb8504c073739085a417978b18cd.css" integrity="sha256-Lt37dpYQ9y9A9ryUnmKjrPKY64UEwHNzkIWkF5eLGM0=" media="(prefers-color-scheme: dark)">


<link rel="stylesheet" href="/scss/print.2744dcbf8a0b2e74f8a50e4b34e5f441be7cf93cc7de27029121c6a09f9e77bc.css" integrity="sha256-J0Tcv4oLLnT4pQ5LNOX0Qb58&#43;TzH3icCkSHGoJ&#43;ed7w=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    
    <link rel="shortcut icon" sizes="192x192" href="/android-192-favicon.png">

    
    <link rel="shortcut icon" href="/android-192-favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/v4-shims.min.css" integrity="sha256-wN7QJaqAwQ03kgUhyN4EU2phRdDkLrQYbFe0EvpQ60U=" crossorigin="anonymous" />

    
    


    
</head>


    <body class="">
    
<div class="sidebar">
  <div class="container ">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://balamaci.ro">Serban Balamaci</a>
      </span>
      
      
        <div class="author-image">
          <img src="https://www.gravatar.com/avatar/309afbf8c2f162060e4fa28d670d2ec8?s=240&d=mp" class="img--circle img--headshot element--center" alt="gravatar">
        </div>
      
      <p class="site__description">
         Java and JVM related 
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Serban Balamaci</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/"><span class='fa-icon'><i class='fas fa-home'></i></span> Home
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/"><span class='fa-icon'><i class='fas fa-stream'></i></span> Posts
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/series/"><span class='fa-icon'><i class='fas fa-list-alt'></i></span> Series
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/tags/"><span class='fa-icon'><i class='fas fa-tags'></i></span> Tags
						<span></span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/whoami/"><span class='fa-icon'><i class='fas fa-id-card'></i></span> About
						<span></span>
					</a>
				</li>
			 
		
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/@sbalamaci" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="bird" class="svg-inline--fa fa-bird fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></i></a>
	
	
	
	<a href="https://github.com/balamaci" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="https://linkedin.com/in/serbanbalamaci" rel="me"><i class="fa-w-16" aria-hidden="true"><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="pro-network" class="svg-inline--fa fa-pro-network fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg></i></a>
	
	
	
	
	
	
	
	
	
</section>

      </div>
    </div>

  </div>
  <div class="container fixed-container">
    
<div class="copyright">
  &copy; 2010 - 2020 Serban Balamaci
  
    <a href="https://creativecommons.org/licenses/by-sa/4.0">CC BY-SA 4.0</a>
  
</div>



  </div>
</div>

        <div class="content container">
            
    

<article>
  <header>
    <h1>Docker containers for Visual Regression Testing setup</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> 2015-08-03
    
    
    
      
      
          in
          
          
              <a class="badge badge-category" href="/categories/docker">DOCKER</a>
              •
          
              <a class="badge badge-category" href="/categories/webdriver">WEBDRIVER</a>
              
          
      
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/docker">docker</a>
           
      
          <a class="badge badge-tag" href="/tags/webdriver">webdriver</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 15 min read

    
    
    

</div>


  </header>
  
  
  
  <div class="post md">
    <h3 id="packing-it-all-inside-docker-containers">Packing it all inside docker containers</h3>
<p>In the previous <a href="http://balamaci.ro/docker-container-for-visual-regression-testing/">post</a> we looked at a possible solution for doing <strong>Visual Regression Testing</strong>. But stepping back and looking at it, I think there was tedious for the reader to actually try it out, because it required him to install some extra dependencies like <strong>ImageMagick</strong>, <strong>phantomjs</strong>( which in turn needs <strong>nodejs</strong>) to be able to run the example himself(also not considering <strong>docker</strong> installation). This would have gotten even more complicated if we wanted to add more browser beside phantomjs, but Docker containers can also be used as &ldquo;build containers&rdquo; not just to run applications.
Doing away with extra configuration of dependencies and just run your application or tests inside a container build from a <strong>Dockerfile</strong> <strong>recipe</strong>(or a prebuilt one available from a repository) is one of the &ldquo;features&rdquo; of working with containers.</p>
<p>Quite a few cloud services have appeared recently that offer to run docker containers. Mix them up with some git hooks and this opens the way to <strong>run unit tests and integration tests inside the containers on each commit</strong> or pull request before merging into your codebase. Something like what <a href="http://www.yegor256.com/2014/07/24/rultor-automated-merging.html">rultor</a> is doing. What a great time to be alive :).</p>
<h3 id="docker">Docker</h3>
<p>We&rsquo;re not going to talk about what Docker is, as we already did it <a href="http://balamaci.ro/docker-series-intro-to-docker/">here</a> some time ago.</p>
<h3 id="the-plan">The plan</h3>
<p>Just a little reminder of what we planned on doing. We have our web application <strong>pippo-demo.war</strong> file which was already built by Jenkins in another step. Part of our build setup we also have separate integration tests and visual regression tests to run for the web application.</p>
<h4 id="running-our-integration-tests-inside-a-prebuilt-docker-container-with-all-the-dependencies-already-baked-in">Running our integration tests inside a prebuilt docker container with all the dependencies already baked in.</h4>
<p>We want to deploy the <strong>pippo-demo.war</strong> inside an &ldquo;actual&rdquo; Tomcat instance and run integration tests using Selenium <strong>Webdriver</strong> against the deployed web app.</p>
<p>To keep things simple we just want to be able to run our integration tests through a single command.</p>
<p>We needed <strong>ImageMagick</strong> along with <strong>phantomjs</strong> and <strong>nodejs</strong> to do the visual regression tests.</p>
<ul>
<li>So we&rsquo;ll create a new <strong>ui-tests</strong> docker image with these dependencies already installed. We base this <strong>ui-tests</strong> image upon a simple <strong>maven3</strong> docker image because it&rsquo;s inside this image we <strong>checkout our integration tests</strong> suite.</li>
</ul>
<p>Our <strong>integration tests are organised as a Maven project</strong> so we can run them with just</p>
<pre><code>mvn clean verify
</code></pre>
<p>We have prepared a generic reusable <strong>Tomcat7 container</strong> into which we deploy <strong>pippo-demo.war</strong>.</p>
<ul>
<li><strong>pre-integration-test</strong> phase we use the <strong>cargo-maven2-plugin</strong> to deploy the application inside the <strong>Tomcat7 container</strong>.</li>
<li><strong>maven-failsafe-plugin</strong> runs our plain JUnit tests with  Webdriver against the endpoints which we already discussed in <a href="http://balamaci.ro/visual-testing-automation/">article</a>.</li>
</ul>
<p><img src="/assets/2015/docker_ui_testing.svg" alt="Build container"></p>
<p>All the dockerfiles necessary to create the images are under <a href="https://github.com/balamaci/blog-ui-testing-container/tree/master/docker">docker</a> folder.</p>
<p>PS: They are there as examples and for should you want to create your own dockerfiles. Be aware that there is an official docker <a href="https://registry.hub.docker.com/_/maven/">repo location</a> for maven containers just know it&rsquo;s built upon an <strong>open-jdk</strong> image(might be a legal issue with distributing the oracle jdk).</p>
<p>That is the reason why I&rsquo;ve not pushed the images myself and will instead maybe change the example to openjdk images.</p>
<h3 id="docker-compose---a-way-of-orchestrating-containers">Docker Compose - a way of &ldquo;orchestrating&rdquo; containers</h3>
<p>Sometimes when you have a more complicated setup, for ex.  your web application for which you do integration testing also requires a database, we can also pack that database inside a container.</p>
<p>It makes sense to have separate services like <strong>databases</strong>, <strong>web containers</strong> defined and kept in separate containers to keep things clear, configurable(for example to be able to test  with a different database) and play around with the &ldquo;big building blocks&rdquo; sort of like legos to swap one component for another.</p>
<p>Orchestrating those containers can get messy: specifying which volume directories are shared with the host or between containers themselves, what ports are to be exposed for each container and  how they should be linked.</p>
<p>This is where <a href="https://github.com/docker/compose">Docker Compose</a>(previously named <strong>fig</strong>) can help us.
Through a file called <strong>docker-compose.yml</strong> you can describe the whole setup. Let&rsquo;s look at the file we&rsquo;ve used for the project:</p>
<pre><code>tomcat:
  image: balamaci/tomcat7
  volumes:
    - /tmp/tomcatlog:/opt/tomcat/logs

uitests:
  image: balamaci/ui-tests
  volumes: 
    - .:/usr/src/app 
    - ~/.m2:/root/.m2 
  links:
    - tomcat
  ports:
    - 8080:8080
</code></pre>
<p>We defined two services <strong>tomcat</strong> and <strong>uitests</strong>.</p>
<p>Our <strong>uitests</strong> container is <strong>linked</strong> to the <strong>tomcat</strong> container. This means there is an entry added into <strong>/etc/hosts</strong> inside the <strong>uitests</strong> container and to access the Tomcat web app server we can just do <em>http://tomcat:8080</em> (from <strong>uitests</strong> which is our actual container in which we run the tests).</p>
<p>With</p>
<pre><code>volumes: 
    - .:/usr/src/app 
</code></pre>
<p>The whole current directory - if we checked out the <a href="https://github.com/balamaci/blog-ui-testing-container/">project</a> - <strong>source files for the integration tests are being shared with the <em>uitests</em> container</strong> through a <strong>docker volume</strong>, they are not &ldquo;burned&rdquo; inside the image(like with the ADD command for Dockerfile). This way we can always checkout new tests and just reuse the same <strong>uitests</strong> container.</p>
<p>while with</p>
<pre><code>  volumes:
    - ~/.m2:/root/.m2 
</code></pre>
<p>We shared the <strong>.m2</strong> folder from the host with the container. That is because we don&rsquo;t want everytime we run our integration tests to pull all of maven dependencies from the internet again and again.</p>
<p>For more detailed help with every command, or what else you can configure be found <a href="https://docs.docker.com/compose/yml/">here</a></p>
<p>If we have added in the config file a <strong>command</strong> line to be executed implicitly then we just could have done</p>
<pre><code>docker-compose up
</code></pre>
<p>but instead we&rsquo;ll run the mvn command explicit</p>
<pre><code>docker-compose run uitests mvn clean verify
</code></pre>
<p>which will also start the linked <strong>tomcat</strong> container</p>
<p>Stopping all the containers is done with:</p>
<pre><code>docker-compose stop 
</code></pre>
<p>to also remove the containers so we have a clean slate:</p>
<pre><code>docker-compose rm 
</code></pre>
<p>PS: We could have done this setup I think with all the dependencies and Tomcat server baked into a single image and container, but we kept things more clear this way and we also get a chance to play with <strong>docker-compose</strong>.
PS 2: <strong>docker-compose</strong> it&rsquo;s just a tool, a facilitator over  docker. The created containers are in everyway &ldquo;plain&rdquo; docker containers, and all docker commands still apply to them.</p>
<h3 id="the-coderun">The coderun</h3>
<p>Installing docker and docker-compose:</p>
<pre><code>#docker
wget -qO- https://get.docker.com/ | sh

#docker-compose installing
curl -L https://github.com/docker/compose/releases/download/1.3.0/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
</code></pre>
<p>clone the repo:</p>
<pre><code>git clone git@github.com:balamaci/blog-ui-testing-container.git
</code></pre>
<p>build the images from the <strong>Dockerfile</strong>s</p>
<pre><code>./build-images.sh
</code></pre>
<p>run the tests:</p>
<pre><code>docker-compose run uitests mvn verify
</code></pre>
<p>stopping and removing the containers:</p>
<pre><code>docker-compose stop
docker-compose rm
</code></pre>
<h3 id="conclusion">Conclusion</h3>
<p><strong>Containers are awesome</strong>, I&rsquo;m really buying into the hype and think they will definitely play a major role at least in helping reaching the next level of automation for testing that require more complex setups.</p>
<p>We&rsquo;ve managed to simply our whole setup as we no longer force the reader to run tedious steps to configure the testing environment.</p>
<p>If we&rsquo;d have pushed our <strong>uitests</strong> image to the <a href="https://hub.docker.com/explore/">docker image registry</a> which offers free hosting for public repos, we could the whole would have been
<strong>checkout the github repo with the integration tests</strong> and run</p>
<pre><code>docker-compose run uitests mvn verify
</code></pre>
<p>With all the services popping up offering the possibility to deploy and run docker containers, while docker alternatives like <a href="https://rocket.readthedocs.org/en/latest/">rocket</a> are being developed, it&rsquo;s definitely worth to keep an eye on evolution of container based packaging and deployments.</p>
<h4 id="references">References</h4>
<p><a href="https://blog.codeship.com/orchestrate-containers-for-development-with-docker-compose/">Docker Compose</a></p>

  </div>
  

<div class="navigation navigation-single">
    
    <a href="/2015/07/28/visual-testing-automation/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">A Solution for Automation of Visual Regression Testing</span>
    </a>
    
    
    <a href="/2015/10/25/using-docker-and-docker-compose-for-orchestrating-a-full-bdd/" class="navigation-next">
      <span class="navigation-tittle">Orchestrating a reusable BDD web testing setup with Selenium grid using docker - Part I</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  

</article>


        </div>
        
    










<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin="anonymous"></script>
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    

<script src="https://cdnjs.cloudflare.com/ajax/libs/zepto/1.2.0/zepto.min.js" integrity="sha256-vrn14y7WH7zgEElyQqm2uCGSQrX/xjYDjniRUQx3NyU=" crossorigin="anonymous"></script>
<script type="text/javascript">
function addBlockSwitches() {
	$('.primary').each(function() {
		primary = $(this);
		createSwitchItem(primary, createBlockSwitch(primary)).item.addClass("selected");
		primary.children('.title').remove();
	});
	$('.secondary').each(function(idx, node) {
		secondary = $(node);
		primary = findPrimary(secondary);
		switchItem = createSwitchItem(secondary, primary.children('.switch'));
		switchItem.content.addClass('hidden');
		findPrimary(secondary).append(switchItem.content);
		secondary.remove();
	});
}

function createBlockSwitch(primary) {
	blockSwitch = $('<div class="switch"></div>');
	primary.prepend(blockSwitch);
	return blockSwitch;
}

function findPrimary(secondary) {
	candidate = secondary.prev();
	while (!candidate.is('.primary')) {
		candidate = candidate.prev();
	}
	return candidate;
}

function createSwitchItem(block, blockSwitch) {
	blockName = block.children('.title').text();
	content = block.children('.content').first().append(block.next('.colist'));
	item = $('<div class="switch--item">' + blockName + '</div>');
	blockSwitch.append(item);
	return {'item': item, 'content': content};
}

function globalSwitch() {
	$('.switch--item').each(function() {
		var blockId = blockIdForSwitchItem($(this));
		$(this).off('click');
		$(this).on('click', function() {
			selectedText = $(this).text()
			window.localStorage.setItem(blockId, selectedText);
			$(".switch--item").filter(function() {
				return blockIdForSwitchItem($(this)) === blockId;
			}).filter(function() {
				return $(this).text() === selectedText;
			}).each(function() {
				select($(this))
			});
		});
		if ($(this).text() === window.localStorage.getItem(blockId)) {
			select($(this))
		}
	});
}

function blockIdForSwitchItem(item) {
	idComponents = []
	idComponents.push(item.text().toLowerCase());
	item.siblings(".switch--item").each(function(index, sibling) {
		idComponents.push($(sibling).text().toLowerCase());
	});
	return idComponents.sort().join("-")
}

function select(selected) {
	selected.addClass('selected');
	selected.siblings().removeClass('selected');
	selectedContent = selected.parent().siblings(".content").eq(selected.index())
	selectedContent.removeClass('hidden');
	selectedContent.siblings().addClass('hidden');
}

$(addBlockSwitches);
$(globalSwitch);
</script>


    



    </body>
</html>

